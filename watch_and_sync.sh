#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./watch_and_sync.sh

# –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
if [ -f ".deploy_config" ]; then
    source .deploy_config
else
    echo "‚ö†Ô∏è  –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ñ–∞–π–ª .deploy_config –Ω–µ –Ω–∞–π–¥–µ–Ω"
fi

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
NC='\033[0m'

# –§—É–Ω–∫—Ü–∏–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
log() {
    echo -e "${GREEN}[$(date +'%Y-%m-%d %H:%M:%S')] $1${NC}"
}

error() {
    echo -e "${RED}[$(date +'%Y-%m-%d %H:%M:%S')] –û–®–ò–ë–ö–ê: $1${NC}"
}

warning() {
    echo -e "${YELLOW}[$(date +'%Y-%m-%d %H:%M:%S')] –í–ù–ò–ú–ê–ù–ò–ï: $1${NC}"
}

info() {
    echo -e "${BLUE}[$(date +'%Y-%m-%d %H:%M:%S')] –ò–ù–§–û: $1${NC}"
}

watch() {
    echo -e "${PURPLE}[$(date +'%Y-%m-%d %H:%M:%S')] –°–õ–ï–ñ–ï–ù–ò–ï: $1${NC}"
}

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
check_dependencies() {
    local deps=("git" "find" "stat")
    for dep in "${deps[@]}"; do
        if ! command -v "$dep" &> /dev/null; then
            error "–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å $dep –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
            exit 1
        fi
    done
}

# –ü–æ–ª—É—á–µ–Ω–∏–µ —Ö—ç—à–µ–π —Ñ–∞–π–ª–æ–≤
get_file_hashes() {
    find . -type f \
        -not -path './.git/*' \
        -not -path './node_modules/*' \
        -not -path './vendor/*' \
        -not -path './temp/*' \
        -not -path './uploads/*' \
        -not -name '*.log' \
        -not -name '*.tmp' \
        -not -name '*.swp' \
        -not -name '.DS_Store' \
        -not -name 'watch_and_sync.sh' \
        -exec stat -f "%m %N" {} \; 2>/dev/null | sort
}

# –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Å–ª–µ–∂–µ–Ω–∏—è
watch_files() {
    local last_hashes=""
    local current_hashes=""

    log "üëÄ –ù–∞—á–∏–Ω–∞–µ–º —Å–ª–µ–∂–µ–Ω–∏–µ –∑–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ —Ñ–∞–π–ª–æ–≤..."
    info "–ù–∞–∂–º–∏—Ç–µ Ctrl+C –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏"

    # –ü–æ–ª—É—á–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ —Ö—ç—à–∏
    last_hashes=$(get_file_hashes)

    while true; do
        sleep 2  # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã

        # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ —Ö—ç—à–∏
        current_hashes=$(get_file_hashes)

        # –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º
        if [ "$last_hashes" != "$current_hashes" ]; then
            watch "–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ñ–∞–π–ª–∞—Ö!"

            # –ñ–¥–µ–º –µ—â–µ 2 —Å–µ–∫—É–Ω–¥—ã –Ω–∞ —Å–ª—É—á–∞–π –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π
            sleep 2

            # –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é
            if [ -f "auto_sync.sh" ]; then
                log "üöÄ –ó–∞–ø—É—Å–∫ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏..."
                if ./auto_sync.sh; then
                    log "‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ"
                else
                    error "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏"
                fi
            else
                error "–§–∞–π–ª auto_sync.sh –Ω–µ –Ω–∞–π–¥–µ–Ω"
            fi

            # –û–±–Ω–æ–≤–ª—è–µ–º —Ö—ç—à–∏
            last_hashes=$(get_file_hashes)
        fi
    done
}

# –§—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–∏–≥–Ω–∞–ª–æ–≤
cleanup() {
    echo ""
    log "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–ª–µ–∂–µ–Ω–∏—è..."
    exit 0
}

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ —Å–∏–≥–Ω–∞–ª–æ–≤
trap cleanup SIGINT SIGTERM

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
check_dependencies()

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö —Ñ–∞–π–ª–æ–≤
if [ ! -f "auto_sync.sh" ]; then
    error "–§–∞–π–ª auto_sync.sh –Ω–µ –Ω–∞–π–¥–µ–Ω. –°–æ–∑–¥–∞–π—Ç–µ –µ–≥–æ —Å –ø–æ–º–æ—â—å—é git_sync.sh"
    exit 1
fi

# –ó–∞–ø—É—Å–∫ —Å–ª–µ–∂–µ–Ω–∏—è
watch_files
